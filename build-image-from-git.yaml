apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-docker-image-from-git-source
spec:
  params:
  - name: pathToDockerFile
    type: string
    description: The path to the dockerfile to build
    default: $(resources.inputs.docker-source.path)/Dockerfile
  - name: skaffoldYAMLDir
    type: string
    description: |
      Skaffold YAML used to drive kaniko
    default: $(resources.inputs.docker-source.path)/
  resources:
    inputs:
    - name: docker-source
      type: git
    outputs:
    - name: builtImage
      type: image
  steps:
  - name: build-and-push
    image: gcr.io/k8s-skaffold/skaffold:v1.13.1
    # specifying DOCKER_CONFIG is required to allow kaniko to detect docker credential
    env:
    - name: "DOCKER_CONFIG"
      value: "/tekton/home/.docker/"
    command:
    - bash
    args:
    - -c
    - |
      ln -s /tekton/home/.docker /home/.docker
      cd $(params.skaffoldYAMLDir)
      skaffold build
    volumeMounts:
      - name: docker-socket
        mountPath: /var/run/docker.sock
  volumes:
    - name: docker-socket
      hostPath:
        path: /var/run/docker.sock
        type: Socket
